


## Deploying to lambda

One does not simply deploy to lambda, but by carefully following these steps it will hopefully be a smooth process.

### IAM

For cloud watch and s3 access we will need to set up a custom role. At first IAM roles may seem intimidating but it is a really nice system once you get the hang of it.

1. [Create Role](https://us-east-1.console.aws.amazon.com/iam/home?region=us-west-2#/roles/create)
	- Trusted Entity Type: AWS Service
	- Use case: Lambda
	- Permissions
		- AmazonS3FullAccess - buckets
		- AWSLambdaBasicExecutionRole - cloud watch
	- name: bevyhub-lambda
	- description: IAM Role for the Bevyhub rust lambda server.
	- restrict s3 to bevyhub-dev & bevyhub-prod
2. Save the arn, we'll need it later


## Custom Domains

The default domain url generated by `cargo-lambda` is very long, lets connect it to a custom domain. There are three steps to do this:
1. Create API Gateway
2. Create TLS Certificate
3. Create Custom Domain

For this tutorial we'll use the following:
- domain: `example.com`
- lambda name: `example`
- api gateway name: `example`


### Create TLS Certificate

1. Visit [ACM](https://us-west-2.console.aws.amazon.com/acm/home)
2. Request a certificate
3. Certificate type: Request a public certificate
4. Domain names: `example.com`
5. Validation method: DNS Validation
6. Key algorithm: RSA 2048
7. Create
8. Add the CNAME value to the sites DNS records
	- The 'CNAME name' will be the host `_84938943kdsjdsacd.example.com.`, so remove the trailing `.example.com.` when entering into your host.
	- The 'CNAME value' will be the value, copy and paste that directly.
9. Grab a coffee, we'll need this to be picked up by acm before creating the custom domain. For me this took 10 mins but it will probably vary greatly.

### Create New Gateway

1. Visit [API Gateway](https://us-west-2.console.aws.amazon.com/apigateway/main/apis) and create a new API
2. API type: HTTP API
3. API Name: (same as lambda name)
4. Integrations: Lambda, same region, select function, default version
5. Configure Routes: (default) any method, resource path: (api name), integration target: (api name)
6. Configure stages: `$default`, auto-deploy: true
7. Create a catch-all route: Develop > Routes > Create
	- route: `$default`
	- Attach Integration: `example`

### Create Custom Domain

1. Visit [Custom Domain Names](https://us-west-2.console.aws.amazon.com/apigateway/main/publish/domain-names)
2. Enter details:
	- Domain name: `example.com`
	- API Endpoint type: Regional
	- Minimal TLS version: 1.2
	- Mutual TLS authentication: false
	- Certificate: select the tls certificate created
3. API Mappings > Configure API Mappings > Add New Mapping:
	- API: `example`
	- Stage: `$default`
	- Path: ``
	- Save
4. Copy the 'API Gateway domain name':
	- note: this will not resolve when visited directly, its special and only for the dns
6. Create DNS Record:
	- type: CNAME
	- host: `@`
	- value: gateway domain name
